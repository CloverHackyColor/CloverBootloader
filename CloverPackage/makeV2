#!/bin/bash
#
# alternate build for CloverV2 (macOS/Linux)

cd "$(dirname "$([ -L "$0" ] && readlink "$0" || echo "$0")")" || exit 1
ROOT="$PWD"

SYMROOT="${ROOT}/sym"
mkdir -p "$SYMROOT"

REVISION=$(git describe --tags "$(git rev-list --tags --max-count=1)" 2>/dev/null || echo "untagged")

# zip CloverV2, excluding .empty and .DS_Store
zip -qr "CloverV2-${REVISION}.zip" CloverV2 -x "*/.DS_Store" "*/.empty"
mv "CloverV2-${REVISION}.zip" "$SYMROOT" || exit 1

# ====== Archiving CLOVERX64.efi ======
cd "$ROOT/CloverV2/EFI/CLOVER/" || exit 1
if [ -f CLOVERX64.efi ]; then
    zip -q CLOVERX64.efi.zip CLOVERX64.efi
    mv CLOVERX64.efi.zip "$SYMROOT" || exit 1
fi
cd "$ROOT" || exit 1

# open folder
if command -v open &>/dev/null; then
    open "$SYMROOT"       # macOS
elif command -v xdg-open &>/dev/null; then
    xdg-open "$SYMROOT"   # Linux
fi

#!/bin/bash
set -e
SYSNAME=$(uname)

# Ensure 7-Zip is available on macOS
if [[ "$SYSNAME" == Darwin ]]; then
    if ! command -v 7zz &>/dev/null; then
        TMPDIR="/private/tmp/7ztemp"
        mkdir -p "$TMPDIR"
        cd "$TMPDIR" || exit 1
        echo "[7-Zip] Downloading 7zz..."
        curl -LO https://www.7-zip.org/a/7z2501-mac.tar.xz
        tar -xf 7z2501-mac.tar.xz
        xattr -d com.apple.quarantine 7zz 2>/dev/null || true
        sudo cp 7zz /opt/local/bin/7zz
        sudo chmod +x /opt/local/bin/7zz
        cd - >/dev/null || exit 1
        rm -rf "$TMPDIR"
        echo "[7-Zip] Installed to /usr/local/bin/7z"
    fi
fi

# Check again
if ! command -v 7zz &>/dev/null; then
    echo "Error: 7zz not found. Please install 7-Zip manually."
    exit 1
fi

# Paths
SRCROOT="$(dirname "$0")"
SYMROOT=${SRCROOT}/sym

[[ ! -d "${SYMROOT}/utils" ]] && { echo "No utils folder found."; exit 1; }

echo "[7-Zip] Packing utils..."
7zz a -t7z "${SYMROOT}/utils.7z" "${SYMROOT}/utils" -mx=9
echo "Done."

# Open folder with archive
if [[ "$SYSNAME" == "Darwin" ]]; then
    open "${SYMROOT}"
elif [[ "$SYSNAME" == "Linux" ]]; then
    xdg-open "${SYMROOT}" >/dev/null 2>&1 &
fi


#!/bin/bash
#
# Clover package build script
# created by vector sigma, refined version
#

# --- Reset locale to avoid GNU sed issues ---
export LC_ALL=C

# --- Ensure the script is called from make (optional warning) ---
caller=$(ps -p $PPID -o comm=)
if [[ "$caller" != "make" ]]; then
    echo "Warning: don't call the '$0' script directly !" >&2
    echo "Use the 'make pkg' command instead" >&2
    # exit 1  # uncomment if you want to enforce this
fi

# --- Define important paths ---
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SYMROOT="$SCRIPT_DIR/sym"
PKG_BUILD_DIR="$SYMROOT/package"

# --- Add local toolchain and gettext to PATH ---
export PATH="$REPO_ROOT/toolchain/bin:$REPO_ROOT/toolchain/bin/gettext/bin:$PATH"

# --- Usage help function ---
usage() {
    echo
    echo -e "\e[1mUsage:\e[0m $0 [flag1 flag2...]"
    echo
    echo "Optional exclude flags passed to buildpkg.sh:"
    echo -e "\e[1m--nothemes\e[0m\tExcludes the Themes subpackage."
    echo -e "\e[1m--norc\e[0m\t\tExcludes the RC scripts subpackage."
    echo -e "\e[1m--nolegacy\e[0m\tExcludes the CloverEFI subpackages."
    echo
}

# --- Parse arguments ---
NOEXTRAS=""
while [[ $# -gt 0 ]]; do
    case "${1}" in
        --nothemes)  NOEXTRAS+=" --nothemes";;
        --norc)      NOEXTRAS+=" --norc";;
        --nolegacy)  NOEXTRAS+=" --nolegacy";;
        *) echo -e "\e[1mInvalid option:\e[0m ${1}"; usage; exit 1;;
    esac
    shift
done

# --- Move to script directory ---
cd "$SCRIPT_DIR" || { echo "Failed to enter script directory"; exit 1; }

# --- Determine latest git revision ---
revision=$(git describe --tags "$(git rev-list --tags --max-count=1)")
echo "$revision" > revision

# --- Translate resources ---
echo
echo "========= Translating Resources ========="
./package/translate.sh || exit $?

# --- Check Xcode installation and build utils ---
xcode_path=$(/usr/bin/xcode-select --print-path 2>/dev/null)
if [[ -n "$xcode_path" ]]; then
    echo "Xcode detected at: $xcode_path"
    echo "Building utils..."
    make -C "${SCRIPT_DIR}/utils" || exit $?
else
    echo "Warning: Xcode not found â€” skipping utils build."
fi

# --- Build installer package ---
echo
echo "========= Building Installer ========="
package/buildpkg.sh \
    --srcroot "$SCRIPT_DIR" \
    --symroot "sym" \
    --builddir "$PKG_BUILD_DIR" \
    ${NOEXTRAS:1} || exit $?

# --- Cleanup temporary files ---
rm -f version revision

# --- Show result and open folder ---
echo
echo "========= Build Complete ========="
ls -la sym
open sym

exit 0

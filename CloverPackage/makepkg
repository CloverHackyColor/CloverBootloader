#!/bin/bash
#
# Reset default charset to avoid GNUsed issues
export LC_ALL=C

# --- Define paths ---
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"        # Script folder
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"         # Repository root

# Add toolchain/bin to PATH
export PATH="$REPO_ROOT/toolchain/bin:$PATH"

# --- Buildpkg.sh options ---
usage () {
  printf "\n\e[1m%s\e[0m\n" "Usage: $0 [flag1 flag2...]"
  printf "\n%s\n" "Optional flags passed to buildpkg.sh:"
  printf "\n\e[1m%s\e[0m\t%s" "--nothemes" "Excludes the Themes subpackage."
  printf "\n\e[1m%s\e[0m\t%s" "--norc" "Excludes the RC scripts subpackage."
  printf "\n\e[1m%s\e[0m\t%s" "--nolegacy" "Excludes the CloverEFI subpackages."
  echo
}

NOEXTRAS=""

while [[ $# -gt 0 ]]; do
  case "${1}" in
    --nothemes ) NOEXTRAS+=" --nothemes";;
    --norc ) NOEXTRAS+=" --norc";;
    --nolegacy ) NOEXTRAS+=" --nolegacy";;
    * ) echo "Invalid option: ${1}!"; usage; exit 1;;
  esac
  shift
done

# --- Change to script directory ---
cd "$SCRIPT_DIR" || exit 1

revision=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "unknown")
SRCROOT="${SCRIPT_DIR}"
SYMROOT="${SRCROOT}/sym"
PKG_BUILD_DIR="${SYMROOT}/package"

echo "${revision}" > revision

# --- Translate resources ---
echo ""
echo "========= Translating Resources ========"
./package/translate.sh || exit $?

# --- Build utils if Xcode exists (macOS only) ---
if command -v xcode-select &>/dev/null; then
  xcode_path=$(/usr/bin/xcode-select --print-path 2>/dev/null)
  if [[ -n "$xcode_path" ]]; then
    make -C "${SRCROOT}/utils" || exit $?
  fi
fi

# --- Build the package ---
package/buildpkg.sh --srcroot "$SRCROOT" --symroot "sym" --builddir "$PKG_BUILD_DIR" $NOEXTRAS || exit $?

# --- Clean temporary files ---
rm -f version revision

# --- Open the output folder ---
if [[ -d sym ]]; then
  ls -la sym
  if [[ "$OSTYPE" == darwin* ]]; then
    open sym
  else
    command -v xdg-open &>/dev/null && xdg-open sym
  fi
fi

exit 0
